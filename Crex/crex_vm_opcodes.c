/*
   +----------------------------------------------------------------------+
   | Crex Engine                                                          |
   +----------------------------------------------------------------------+
   | Copyright (c) Crex Technologies Ltd. (http://www.crex.com)           |
   +----------------------------------------------------------------------+
   | This source file is subject to version 2.00 of the Crex license,     |
   | that is bundled with this package in the file LICENSE, and is        |
   | available through the world-wide-web at the following url:           |
   | http://www.crex.com/license/2_00.txt.                                |
   | If you did not receive a copy of the Crex license and are unable to  |
   | obtain it through the world-wide-web, please send a note to          |
   | license@crex.com so we can mail you a copy immediately.              |
   +----------------------------------------------------------------------+
   | Authors: Andi Gutmans <andi@crx.net>                                 |
   |          Zeev Suraski <zeev@crx.net>                                 |
   |          Dmitry Stogov <dmitry@crx.net>                              |
   +----------------------------------------------------------------------+
*/

#include <stdio.h>
#include <crex.h>
#include <crex_vm_opcodes.h>

static const char *crex_vm_opcodes_names[204] = {
	"CREX_NOP",
	"CREX_ADD",
	"CREX_SUB",
	"CREX_MUL",
	"CREX_DIV",
	"CREX_MOD",
	"CREX_SL",
	"CREX_SR",
	"CREX_CONCAT",
	"CREX_BW_OR",
	"CREX_BW_AND",
	"CREX_BW_XOR",
	"CREX_POW",
	"CREX_BW_NOT",
	"CREX_BOOL_NOT",
	"CREX_BOOL_XOR",
	"CREX_IS_IDENTICAL",
	"CREX_IS_NOT_IDENTICAL",
	"CREX_IS_EQUAL",
	"CREX_IS_NOT_EQUAL",
	"CREX_IS_SMALLER",
	"CREX_IS_SMALLER_OR_EQUAL",
	"CREX_ASSIGN",
	"CREX_ASSIGN_DIM",
	"CREX_ASSIGN_OBJ",
	"CREX_ASSIGN_STATIC_PROP",
	"CREX_ASSIGN_OP",
	"CREX_ASSIGN_DIM_OP",
	"CREX_ASSIGN_OBJ_OP",
	"CREX_ASSIGN_STATIC_PROP_OP",
	"CREX_ASSIGN_REF",
	"CREX_QM_ASSIGN",
	"CREX_ASSIGN_OBJ_REF",
	"CREX_ASSIGN_STATIC_PROP_REF",
	"CREX_PRE_INC",
	"CREX_PRE_DEC",
	"CREX_POST_INC",
	"CREX_POST_DEC",
	"CREX_PRE_INC_STATIC_PROP",
	"CREX_PRE_DEC_STATIC_PROP",
	"CREX_POST_INC_STATIC_PROP",
	"CREX_POST_DEC_STATIC_PROP",
	"CREX_JMP",
	"CREX_JMPZ",
	"CREX_JMPNZ",
	NULL,
	"CREX_JMPC_EX",
	"CREX_JMPNC_EX",
	"CREX_CASE",
	"CREX_CHECK_VAR",
	"CREX_SEND_VAR_NO_REF_EX",
	"CREX_CAST",
	"CREX_BOOL",
	"CREX_FAST_CONCAT",
	"CREX_ROPE_INIT",
	"CREX_ROPE_ADD",
	"CREX_ROPE_END",
	"CREX_BEGIN_SILENCE",
	"CREX_END_SILENCE",
	"CREX_INIT_FCALL_BY_NAME",
	"CREX_DO_FCALL",
	"CREX_INIT_FCALL",
	"CREX_RETURN",
	"CREX_RECV",
	"CREX_RECV_INIT",
	"CREX_SEND_VAL",
	"CREX_SEND_VAR_EX",
	"CREX_SEND_REF",
	"CREX_NEW",
	"CREX_INIT_NS_FCALL_BY_NAME",
	"CREX_FREE",
	"CREX_INIT_ARRAY",
	"CREX_ADD_ARRAY_ELEMENT",
	"CREX_INCLUDE_OR_EVAL",
	"CREX_UNSET_VAR",
	"CREX_UNSET_DIM",
	"CREX_UNSET_OBJ",
	"CREX_FE_RESET_R",
	"CREX_FE_FETCH_R",
	"CREX_EXIT",
	"CREX_FETCH_R",
	"CREX_FETCH_DIM_R",
	"CREX_FETCH_OBJ_R",
	"CREX_FETCH_W",
	"CREX_FETCH_DIM_W",
	"CREX_FETCH_OBJ_W",
	"CREX_FETCH_RW",
	"CREX_FETCH_DIM_RW",
	"CREX_FETCH_OBJ_RW",
	"CREX_FETCH_IS",
	"CREX_FETCH_DIM_IS",
	"CREX_FETCH_OBJ_IS",
	"CREX_FETCH_FUNC_ARG",
	"CREX_FETCH_DIM_FUNC_ARG",
	"CREX_FETCH_OBJ_FUNC_ARG",
	"CREX_FETCH_UNSET",
	"CREX_FETCH_DIM_UNSET",
	"CREX_FETCH_OBJ_UNSET",
	"CREX_FETCH_LIST_R",
	"CREX_FETCH_CONSTANT",
	"CREX_CHECK_FUNC_ARG",
	"CREX_EXT_STMT",
	"CREX_EXT_FCALL_BEGIN",
	"CREX_EXT_FCALL_END",
	"CREX_EXT_NOP",
	"CREX_TICKS",
	"CREX_SEND_VAR_NO_REF",
	"CREX_CATCH",
	"CREX_THROW",
	"CREX_FETCH_CLASS",
	"CREX_CLONE",
	"CREX_RETURN_BY_REF",
	"CREX_INIT_METHOD_CALL",
	"CREX_INIT_STATIC_METHOD_CALL",
	"CREX_ISSET_ISEMPTY_VAR",
	"CREX_ISSET_ISEMPTY_DIM_OBJ",
	"CREX_SEND_VAL_EX",
	"CREX_SEND_VAR",
	"CREX_INIT_USER_CALL",
	"CREX_SEND_ARRAY",
	"CREX_SEND_USER",
	"CREX_STRLEN",
	"CREX_DEFINED",
	"CREX_TYPE_CHECK",
	"CREX_VERIFY_RETURN_TYPE",
	"CREX_FE_RESET_RW",
	"CREX_FE_FETCH_RW",
	"CREX_FE_FREE",
	"CREX_INIT_DYNAMIC_CALL",
	"CREX_DO_ICALL",
	"CREX_DO_UCALL",
	"CREX_DO_FCALL_BY_NAME",
	"CREX_PRE_INC_OBJ",
	"CREX_PRE_DEC_OBJ",
	"CREX_POST_INC_OBJ",
	"CREX_POST_DEC_OBJ",
	"CREX_ECHO",
	"CREX_OP_DATA",
	"CREX_INSTANCEOF",
	"CREX_GENERATOR_CREATE",
	"CREX_MAKE_REF",
	"CREX_DECLARE_FUNCTION",
	"CREX_DECLARE_LAMBDA_FUNCTION",
	"CREX_DECLARE_CONST",
	"CREX_DECLARE_CLASS",
	"CREX_DECLARE_CLASS_DELAYED",
	"CREX_DECLARE_ANON_CLASS",
	"CREX_ADD_ARRAY_UNPACK",
	"CREX_ISSET_ISEMPTY_PROP_OBJ",
	"CREX_HANDLE_EXCEPTION",
	"CREX_USER_OPCODE",
	"CREX_ASSERT_CHECK",
	"CREX_JMP_SET",
	"CREX_UNSET_CV",
	"CREX_ISSET_ISEMPTY_CV",
	"CREX_FETCH_LIST_W",
	"CREX_SEPARATE",
	"CREX_FETCH_CLASS_NAME",
	"CREX_CALL_TRAMPOLINE",
	"CREX_DISCARD_EXCEPTION",
	"CREX_YIELD",
	"CREX_GENERATOR_RETURN",
	"CREX_FAST_CALL",
	"CREX_FAST_RET",
	"CREX_RECV_VARIADIC",
	"CREX_SEND_UNPACK",
	"CREX_YIELD_FROM",
	"CREX_COPY_TMP",
	"CREX_BIND_GLOBAL",
	"CREX_COALESCE",
	"CREX_SPACESHIP",
	"CREX_FUNC_NUM_ARGS",
	"CREX_FUNC_GET_ARGS",
	"CREX_FETCH_STATIC_PROP_R",
	"CREX_FETCH_STATIC_PROP_W",
	"CREX_FETCH_STATIC_PROP_RW",
	"CREX_FETCH_STATIC_PROP_IS",
	"CREX_FETCH_STATIC_PROP_FUNC_ARG",
	"CREX_FETCH_STATIC_PROP_UNSET",
	"CREX_UNSET_STATIC_PROP",
	"CREX_ISSET_ISEMPTY_STATIC_PROP",
	"CREX_FETCH_CLASS_CONSTANT",
	"CREX_BIND_LEXICAL",
	"CREX_BIND_STATIC",
	"CREX_FETCH_THIS",
	"CREX_SEND_FUNC_ARG",
	"CREX_ISSET_ISEMPTY_THIS",
	"CREX_SWITCH_LONG",
	"CREX_SWITCH_STRING",
	"CREX_IN_ARRAY",
	"CREX_COUNT",
	"CREX_GET_CLASS",
	"CREX_GET_CALLED_CLASS",
	"CREX_GET_TYPE",
	"CREX_ARRAY_KEY_EXISTS",
	"CREX_MATCH",
	"CREX_CASE_STRICT",
	"CREX_MATCH_ERROR",
	"CREX_JMP_NULL",
	"CREX_CHECK_UNDEF_ARGS",
	"CREX_FETCH_GLOBALS",
	"CREX_VERIFY_NEVER_TYPE",
	"CREX_CALLABLE_CONVERT",
	"CREX_BIND_INIT_STATIC_OR_JMP",
};

static uint32_t crex_vm_opcodes_flags[204] = {
	0x00000000,
	0x00000b0b,
	0x00000b0b,
	0x80000b0b,
	0x00000707,
	0x00000b0b,
	0x00000b0b,
	0x00000b0b,
	0x40000707,
	0x80000b0b,
	0x80000b0b,
	0x80000b0b,
	0x00000707,
	0x0000000b,
	0x00000007,
	0x80000707,
	0x80000303,
	0x80000303,
	0x80000707,
	0x80000707,
	0x00000b0b,
	0x00000b0b,
	0x00000301,
	0x00006701,
	0x00040751,
	0x00040000,
	0x04000701,
	0x04006701,
	0x04000751,
	0x04000000,
	0x0b000101,
	0x00000003,
	0x0b040751,
	0x0b040000,
	0x00000001,
	0x00000001,
	0x00000001,
	0x00000001,
	0x00040000,
	0x00040000,
	0x00040000,
	0x00040000,
	0x00000020,
	0x00002007,
	0x00002007,
	0x00000000,
	0x00002007,
	0x00002007,
	0x00000705,
	0x00000101,
	0x00001301,
	0x07000003,
	0x00000007,
	0x00000707,
	0x01000701,
	0x01000701,
	0x01000701,
	0x00000000,
	0x00000001,
	0x01040300,
	0x00000000,
	0x01040310,
	0x00000003,
	0x00040110,
	0x00040310,
	0x00001307,
	0x00001301,
	0x00001301,
	0x0100a173,
	0x01040300,
	0x00000005,
	0x00186703,
	0x00106703,
	0x08000007,
	0x00010107,
	0x00000701,
	0x00040751,
	0x00002003,
	0x03000001,
	0x00000000,
	0x00010107,
	0x00000707,
	0x00040757,
	0x00010107,
	0x00006701,
	0x00640751,
	0x00010107,
	0x00006701,
	0x00040751,
	0x00010107,
	0x00000707,
	0x00040757,
	0x00010107,
	0x00006703,
	0x00240753,
	0x00010107,
	0x00000701,
	0x00040751,
	0x0000070b,
	0x00040391,
	0x00001301,
	0x00000000,
	0x00000000,
	0x00000000,
	0x00000000,
	0x01000000,
	0x00001301,
	0x02042003,
	0x00000007,
	0x00040771,
	0x00000057,
	0x0b000003,
	0x01040757,
	0x01048773,
	0x00030107,
	0x00020707,
	0x00001303,
	0x00001301,
	0x01000703,
	0x01000000,
	0x00001003,
	0x00000007,
	0x00040003,
	0x09000007,
	0x0000a103,
	0x00002003,
	0x03000001,
	0x00000005,
	0x01000700,
	0x00000000,
	0x00000000,
	0x00000000,
	0x00040751,
	0x00040751,
	0x00040751,
	0x00040751,
	0x00000007,
	0x00000000,
	0x00047305,
	0x00000000,
	0x00000101,
	0x00001000,
	0x00001003,
	0x00000303,
	0x00000003,
	0x00000303,
	0x00040000,
	0x00000000,
	0x00060757,
	0x00000000,
	0x00000000,
	0x00002000,
	0x00002003,
	0x00000101,
	0x00020101,
	0x00000701,
	0x00000101,
	0x00000075,
	0x00000000,
	0x00000000,
	0x0b000703,
	0x00000003,
	0x00000020,
	0x00003000,
	0x00040110,
	0x00000000,
	0x00000007,
	0x00000105,
	0x00040301,
	0x00002003,
	0x00000707,
	0x00000101,
	0x00000103,
	0x00047000,
	0x00647000,
	0x00047000,
	0x00047000,
	0x00247000,
	0x00047000,
	0x00040000,
	0x00067000,
	0x00040b73,
	0x00100101,
	0x00100001,
	0x00000101,
	0x00001301,
	0x00000101,
	0x0300030b,
	0x0300030b,
	0x01000303,
	0x00000107,
	0x00000107,
	0x00000101,
	0x00000103,
	0x00000707,
	0x0300030b,
	0x00000301,
	0x0000010b,
	0x00002003,
	0x00000101,
	0x00000101,
	0x00000101,
	0x00000101,
	0x00002001,
};

CREX_API const char* CREX_FASTCALL crex_get_opcode_name(uint8_t opcode) {
	if (UNEXPECTED(opcode > CREX_VM_LAST_OPCODE)) {
		return NULL;
	}
	return crex_vm_opcodes_names[opcode];
}
CREX_API uint32_t CREX_FASTCALL crex_get_opcode_flags(uint8_t opcode) {
	if (UNEXPECTED(opcode > CREX_VM_LAST_OPCODE)) {
		opcode = CREX_NOP;
	}
	return crex_vm_opcodes_flags[opcode];
}
CREX_API uint8_t crex_get_opcode_id(const char *name, size_t length) {
	uint8_t opcode;
	for (opcode = 0; opcode < (sizeof(crex_vm_opcodes_names) / sizeof(crex_vm_opcodes_names[0])) - 1; opcode++) {
		const char *opcode_name = crex_vm_opcodes_names[opcode];
		if (opcode_name && strncmp(opcode_name, name, length) == 0) {
			return opcode;
		}
	}
	return CREX_VM_LAST_OPCODE + 1;
}
