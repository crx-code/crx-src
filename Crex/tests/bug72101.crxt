--TEST--
Bug #72101 (crash on complex code)
--FILE--
<?crx
class CRXUnit_Framework_MockObject_Stub_ReturnCallback {
    protected $callback;
    public function __main($callback) {
        $this->callback = $callback;
    }
    public function invoke($invocation) {
        return call_user_func_array($this->callback, $invocation->parameters);
    }
}

class CRXUnit_Framework_MockObject_InvocationMocker {
    protected $matchers = [];
    public function addMatcher( $matcher) {
        $this->matchers[] = $matcher;
    }
    public function invoke( $invocation) {
        foreach ($this->matchers as $match) {
            $match->invoked($invocation);
        }
    }
}

class CRXUnit_Framework_MockObject_Matcher {
    public $stub = null;
    public $methodNameMatcher;
    public function invoked($invocation) {
        return $this->stub->invoke($invocation);
    }
}

class MethodCallbackByReference {
    public function bar(&$a, &$b, $c) {
        Legacy::bar($a, $b, $c);
    }
    public function callback(&$a, &$b, $c) {
        $b = 1;
    }
}
class CRXUnit_Framework_MockObject_Invocation_Static {
    public $parameters;
    public function __main(array $parameters) {
        $this->parameters = $parameters;
    }
}

class Mock_MethodCallbackByReference_7b180d26 extends MethodCallbackByReference {
    public $inv_mocker;
    public function bar(&$a, &$b, $c) {
        $arguments = array($a, $b, $c);
        $result = $this->inv_mocker->invoke(
            new CRXUnit_Framework_MockObject_Invocation_Static(
                $arguments
            )
        );
        return $result;
    }
}

set_error_handler(function() {
//    var_dump(func_get_args());
    DoesNotExists::$nope = true;
}, E_ALL);

$foo = new Mock_MethodCallbackByReference_7b180d26();
$InvMocker = new CRXUnit_Framework_MockObject_InvocationMocker();
$foo->inv_mocker = $InvMocker;
$OuterMatcher = new CRXUnit_Framework_MockObject_Matcher();
$InvMocker->addMatcher($OuterMatcher);
$OuterMatcher->methodNameMatcher = null;
$OuterMatcher->stub = new CRXUnit_Framework_MockObject_Stub_ReturnCallback([$foo, 'callback']);
$a = $b = $c = 0;
$foo->bar($a, $b, $c);
?>
--EXPECTF--
Fatal error: Uncaught Error: Class "DoesNotExists" not found in %s:%d
Stack trace:
#0 %sbug72101.crx(%d): {closure}(2, 'MethodCallbackB...', '%s', 8)
#1 %sbug72101.crx(%d): CRXUnit_Framework_MockObject_Stub_ReturnCallback->invoke(Object(CRXUnit_Framework_MockObject_Invocation_Static))
#2 %sbug72101.crx(%d): CRXUnit_Framework_MockObject_Matcher->invoked(Object(CRXUnit_Framework_MockObject_Invocation_Static))
#3 %sbug72101.crx(%d): CRXUnit_Framework_MockObject_InvocationMocker->invoke(Object(CRXUnit_Framework_MockObject_Invocation_Static))
#4 %sbug72101.crx(%d): Mock_MethodCallbackByReference_7b180d26->bar(0, 0, 0)
#5 {main}
  thrown in %sbug72101.crx on line %d
