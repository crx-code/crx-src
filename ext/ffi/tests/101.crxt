--TEST--
FFI 101: CRX symbols (function address)
--EXTENSIONS--
ffi
--SKIPIF--
<?crx require_once('utils.inc'); ?>
<?crx
try {
    ffi_cdef("extern void *crex_printf;", ffi_get_crx_dll_name());
} catch (Throwable $e) {
    die('skip CRX symbols not available');
}
?>
--INI--
ffi.enable=1
--FILE--
<?crx
require_once('utils.inc');
$fastcall = ffi_get_fastcall_specifier();
$crex = ffi_cdef("
    const char *get_crex_version(void);
    //char *get_crex_version(void);
    extern size_t (*crex_printf)(const char *format, ...);

    unsigned long $fastcall crex_hash_func(const char *str, size_t len);

    void $fastcall crex_str_tolower(char *str, size_t length);

", ffi_get_crx_dll_name());
$f = $crex->get_crex_version;
var_dump(trim(explode("\n",$f())[0]));
//var_dump(trim(FFI::string($crex->get_crex_version())));
var_dump($crex->crex_printf);
var_dump(($crex->crex_printf)("Hello %s!\n", "World"));

$f = $crex->crex_hash_func;
var_dump($f("file", strlen("file")));

$str = $crex->new("char[16]");
FFI::memcpy($str, "Hello World!", strlen("Hello World!"));
$f = $crex->crex_str_tolower;
$f($str, strlen("Hello World!"));
var_dump(FFI::string($str));

?>
--EXPECTF--
string(%d) "Crex Engine %s"
object(FFI\CData:uint%d_t(*)())#%d (1) {
  [0]=>
  object(FFI\CData:uint%d_t())#%d (0) {
  }
}
Hello World!
int(13)
int(%i)
string(12) "hello world!"
