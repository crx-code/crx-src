--TEST--
SOAP customized Content-Type, eg. SwA use case
--EXTENSIONS--
soap
--SKIPIF--
<?crx
    if (!file_exists(__DIR__ . "/../../../sapi/cli/tests/crx_cli_server.inc")) {
        echo "skip sapi/cli/tests/crx_cli_server.inc required but not found";
    }
?>
--FILE--
<?crx

include __DIR__ . "/../../../sapi/cli/tests/crx_cli_server.inc";

$args = ["-d", "extension_dir=" . ini_get("extension_dir"), "-d", "extension=" . (substr(CRX_OS, 0, 3) == "WIN" ? "crx_" : "") . "soap." . CRX_SHLIB_SUFFIX];
if (crx_ini_loaded_file()) {
  // Necessary such that it works from a development directory in which case extension_dir might not be the real extension dir
  $args[] = "-c";
  $args[] = crx_ini_loaded_file();
}
$code = <<<'CRX'
/* Receive */
$content = trim(file_get_contents("crx://input")) . CRX_EOL;
CRX;

crx_cli_server_start($code, null, $args);

$client = new soapclient(NULL, [
  'location' => 'http://' . CRX_CLI_SERVER_ADDRESS,
  'uri' => 'misc-uri',
  'soap_version' => SOAP_1_2,
  'user_agent' => 'Vincent JARDIN, test headers',
  'trace' => true, /* record the headers before sending */
  'stream_context' => stream_context_create([
    'http' => [
      'header' => sprintf("MIME-Version: 1.0\r\n"),
      'content_type' => sprintf("Multipart/Related")
    ],
  ]),
]);

$client->__soapCall("foo", [ 'arg1' => "XXXbar"]);

$headers = $client->__getLastRequestHeaders();

if (strpos($headers, 'Multipart/Related; action="misc-uri#foo"') === FALSE)
  printf("Content-Type NOK %s" . CRX_EOL, $headers);
else
  printf("Content-Type OK" . CRX_EOL);

/*
 * In case of an empty content-type, let's fallback to the default content.
 */
$client2 = new soapclient(NULL, [
  'location' => 'http://' . CRX_CLI_SERVER_ADDRESS,
  'uri' => 'misc-uri',
  'soap_version' => SOAP_1_2,
  'user_agent' => 'Vincent JARDIN, test headers',
  'trace' => true, /* record the headers before sending */
  'stream_context' => stream_context_create([
    'http' => [
      'header' => sprintf("MIME-Version: 1.0\r\n"),
      'content_type' => sprintf("")
    ],
  ]),
]);

$client2->__soapCall("foo", [ 'arg1' => "XXXbar"]);

$headers = $client2->__getLastRequestHeaders();

if (strpos($headers, 'Content-Type: application/soap+xml; charset=utf-8; action="misc-uri#foo"') === FALSE)
  printf("Content-Type Default NOK %s" . CRX_EOL, $headers);
else
  printf("Content-Type Default OK" . CRX_EOL);
?>
--EXPECT--
Content-Type OK
Content-Type Default OK
