--TEST--
Crxa with object in metadata
--EXTENSIONS--
crxa
--INI--
crxa.require_hash=0
crxa.readonly=0
--FILE--
<?crx
class EchoesOnWakeup {
    public function __wakeup() {
        echo "In __wakeup " . spl_object_id($this) . "\n";
    }
    public function __destruct() {
        echo "In __destruct " . spl_object_id($this) . "\n";
    }
}
class ThrowsOnSerialize {
    public function __sleep() {
        throw new RuntimeException("In sleep");
    }
}
$fname = __DIR__ . '/' . basename(__FILE__, '.crx') . '.crxa.crx';
$pname = 'crxa://' . $fname;
$file = "<?crx __HALT_COMPILER(); ?>";

$files = array();
$files['a'] = array('cont' => 'a', 'meta' => new EchoesOnWakeup());
include 'files/crxa_test.inc';

foreach($files as $name => $cont) {
    var_dump(file_get_contents($pname.'/'.$name));
}
unset($files);

$crxa = new Crxa($fname);
echo "Loading metadata for 'a' without allowed_classes\n";
var_dump($crxa['a']->getMetadata(['allowed_classes' => []]));
echo "Loading metadata for 'a' with allowed_classes\n";
var_dump($crxa['a']->getMetadata(['allowed_classes' => true]));
unset($crxa);
// NOTE: Crxa will use the cached value of metadata if setMetaData was called on that Crxa path before.
// Save the writes to the crxa and use a different file path.
$fname_new = "$fname.copy.crx";
copy($fname, $fname_new);
$crxa = new Crxa($fname_new);
echo "Loading metadata from 'a' from the new crxa\n";
var_dump($crxa['a']->getMetadata());
echo "Loading metadata from 'a' from the new crxa with unserialize options\n";
var_dump($crxa['a']->getMetadata(['allowed_classes' => true]));
// CrxaEntry->setMetaData will do the following:
// 1. serialize, checking for exceptions
// 2. free the original data, checking for exceptions or the data getting set from destructors or error handlers.
// 3. set the new data.
try {
    var_dump($crxa['a']->setMetadata(new ThrowsOnSerialize()));
} catch (RuntimeException $e) {
    echo "Caught {$e->getMessage()} at {$e->getFile()}:{$e->getLine()}\n";
    unset($e);
}
var_dump($crxa['a']->getMetadata([]));
var_dump($crxa['a']->getMetadata(['allowed_classes' => false]));

?>
--CLEAN--
<?crx
unlink(__DIR__ . '/' . basename(__FILE__, '.clean.crx') . '.crxa.crx');
unlink(__DIR__ . '/' . basename(__FILE__, '.clean.crx') . '.crxa.crx.copy.crx');
?>
--EXPECTF--
In __destruct 1
string(1) "a"
Loading metadata for 'a' without allowed_classes
object(__CRX_Incomplete_Class)#3 (1) {
  ["__CRX_Incomplete_Class_Name"]=>
  string(14) "EchoesOnWakeup"
}
Loading metadata for 'a' with allowed_classes
In __wakeup 2
object(EchoesOnWakeup)#2 (0) {
}
In __destruct 2
Loading metadata from 'a' from the new crxa
In __wakeup 3
object(EchoesOnWakeup)#3 (0) {
}
In __destruct 3
Loading metadata from 'a' from the new crxa with unserialize options
In __wakeup 2
object(EchoesOnWakeup)#2 (0) {
}
In __destruct 2
Caught In sleep at %scrxa_metadata_write4.crx:12
In __wakeup 3
object(EchoesOnWakeup)#3 (0) {
}
In __destruct 3
object(__CRX_Incomplete_Class)#4 (1) {
  ["__CRX_Incomplete_Class_Name"]=>
  string(14) "EchoesOnWakeup"
}