--TEST--
Crxa with unsafe object in metadata does not unserialize on reading a file.
--EXTENSIONS--
crxa
--INI--
crxa.require_hash=0
crxa.readonly=0
--FILE--
<?crx
class EchoesOnWakeup {
    public function __wakeup() {
        echo "In wakeup\n";
    }
}
$fname = __DIR__ . '/' . basename(__FILE__, '.crx') . '.crxa.crx';
$pname = 'crxa://' . $fname;
$file = "<?crx __HALT_COMPILER(); ?>";

$files = array();
$files['a'] = array('cont' => 'contents of file a');
include 'files/crxa_test.inc';

echo "Reading file contents through stream wrapper\n";
foreach($files as $name => $cont) {
    var_dump(file_get_contents($pname.'/'.$name));
}

$crxa = new Crxa($fname);
echo "Original metadata\n";
var_dump($crxa->getMetadata());
$crxa->setMetadata(new EchoesOnWakeup());
unset($crxa);
// NOTE: Crxa will use the cached value of metadata if setMetaData was called on that Crxa path before.
// Save the writes to the crxa and use a different file path.
$fname_new = "$fname.copy.crx";
copy($fname, $fname_new);
$crxa = new Crxa($fname_new);
echo "Calling getMetadata\n";
var_dump($crxa->getMetadata());
echo "Calling getMetadata with no allowed_classes\n";
var_dump($crxa->getMetadata(['allowed_classes' => []]));
echo "Calling getMetadata with EchoesOnWakeup allowed\n";
var_dump($crxa->getMetadata(['allowed_classes' => [EchoesOnWakeup::class]]));
// Part of this is a test that there are no unexpected behaviors when both selMetadata and getMetadata are used
$crxa->setMetaData([new EchoesOnWakeup(), new stdClass()]);
echo "Calling getMetadata with too low max_depth\n";
var_dump($crxa->getMetadata(['max_depth' => 1]));
echo "Calling getMetadata with some allowed classes\n";
var_dump($crxa->getMetadata(['allowed_classes' => [EchoesOnWakeup::class]]));
echo "Calling getMetadata with no options returns the original metadata value\n";
var_dump($crxa->getMetadata());
unset($crxa);

?>
--CLEAN--
<?crx
unlink(__DIR__ . '/' . basename(__FILE__, '.clean.crx') . '.crxa.crx');
unlink(__DIR__ . '/' . basename(__FILE__, '.clean.crx') . '.crxa.crx.copy.crx');
?>
--EXPECTF--
Reading file contents through stream wrapper
string(18) "contents of file a"
Original metadata
NULL
Calling getMetadata
In wakeup
object(EchoesOnWakeup)#2 (0) {
}
Calling getMetadata with no allowed_classes
object(__CRX_Incomplete_Class)#2 (1) {
  ["__CRX_Incomplete_Class_Name"]=>
  string(14) "EchoesOnWakeup"
}
Calling getMetadata with EchoesOnWakeup allowed
In wakeup
object(EchoesOnWakeup)#2 (0) {
}
Calling getMetadata with too low max_depth

Warning: Crxa::getMetadata(): Maximum depth of 1 exceeded. The depth limit can be changed using the max_depth unserialize() option or the unserialize_max_depth ini setting in %scrxa_metadata_write3.crx on line 39

Warning: Crxa::getMetadata(): Error at offset 34 of 59 bytes in %scrxa_metadata_write3.crx on line 39
bool(false)
Calling getMetadata with some allowed classes
In wakeup
array(2) {
  [0]=>
  object(EchoesOnWakeup)#4 (0) {
  }
  [1]=>
  object(__CRX_Incomplete_Class)#5 (1) {
    ["__CRX_Incomplete_Class_Name"]=>
    string(8) "stdClass"
  }
}
Calling getMetadata with no options returns the original metadata value
array(2) {
  [0]=>
  object(EchoesOnWakeup)#2 (0) {
  }
  [1]=>
  object(stdClass)#3 (0) {
  }
}
