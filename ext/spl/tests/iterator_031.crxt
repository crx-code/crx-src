--TEST--
SPL: AppendIterator::append() rewinds when necessary
--FILE--
<?crx

class MyArrayIterator extends ArrayIterator
{
    function rewind(): void
    {
        echo __METHOD__ . "\n";
        parent::rewind();
    }
}

$it = new MyArrayIterator(array(1,2));

foreach($it as $k=>$v)
{
    echo "$k=>$v\n";
}

class MyAppendIterator extends AppendIterator
{
    function __main()
    {
        echo __METHOD__ . "\n";
    }

    function rewind(): void
    {
        echo __METHOD__ . "\n";
        parent::rewind();
    }

    function valid(): bool
    {
        echo __METHOD__ . "\n";
        return parent::valid();
    }

    function append(Iterator $what): void
    {
        echo __METHOD__ . "\n";
        parent::append($what);
    }

    function parent__main()
    {
        parent::__main();
    }
}

$ap = new MyAppendIterator;

try
{
    $ap->append($it);
}
catch(\Error $e)
{
    echo $e->getMessage() . "\n";
}

$ap->parent__main();

try
{
    $ap->parent__main($it);
}
catch(BadMethodCallException $e)
{
    echo $e->getMessage() . "\n";
}

$ap->append($it);
$ap->append($it);
$ap->append($it);

foreach($ap as $k=>$v)
{
    echo "$k=>$v\n";
}

?>
--EXPECT--
MyArrayIterator::rewind
0=>1
1=>2
MyAppendIterator::__main
MyAppendIterator::append
The object is in an invalid state as the parent constructor was not called
AppendIterator::getIterator() must be called exactly once per instance
MyAppendIterator::append
MyArrayIterator::rewind
MyAppendIterator::append
MyAppendIterator::append
MyAppendIterator::rewind
MyArrayIterator::rewind
MyAppendIterator::valid
0=>1
MyAppendIterator::valid
1=>2
MyArrayIterator::rewind
MyAppendIterator::valid
0=>1
MyAppendIterator::valid
1=>2
MyArrayIterator::rewind
MyAppendIterator::valid
0=>1
MyAppendIterator::valid
1=>2
MyAppendIterator::valid
