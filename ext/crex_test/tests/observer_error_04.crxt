--TEST--
Observer: fatal errors caught with crex_try will not fire end handlers prematurely
--EXTENSIONS--
crex_test
soap
--INI--
crex_test.observer.enabled=1
crex_test.observer.observe_all=1
crex_test.observer.show_return_value=1
--FILE--
<?crx
function foo()
{
    // ext/soap catches a crex_bailout and then throws an exception
    $client = new SoapClient('foo');
}

function main()
{
    foo();
}

// try/catch is on main() to ensure CREX_HANDLE_EXCEPTION does not fire the end handlers again
try {
    main();
} catch (SoapFault $e) {
    echo $e->getMessage() . CRX_EOL;
}

echo 'Done.' . CRX_EOL;
?>
--EXPECTF--
<!-- init '%s%eobserver_error_%d.crx' -->
<file '%s%eobserver_error_%d.crx'>
  <!-- init main() -->
  <main>
    <!-- init foo() -->
    <foo>
      <!-- init SoapClient::__main() -->
      <SoapClient::__main>
        <!-- Exception: SoapFault -->
      </SoapClient::__main:NULL>
      <!-- Exception: SoapFault -->
    </foo:NULL>
    <!-- Exception: SoapFault -->
  </main:NULL>
  <!-- init Exception::getMessage() -->
  <Exception::getMessage>
  </Exception::getMessage:'SOAP-ERROR: Parsing WSDL: Couldn\'t load from \'foo\' : failed to load external entity "foo"
'>
SOAP-ERROR: Parsing WSDL: Couldn't load from 'foo' : failed to load external entity "foo"

Done.
</file '%s%eobserver_error_%d.crx'>
