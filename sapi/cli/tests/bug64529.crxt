--TEST--
Bug #64529 (Ran out of opcode space)
--EXTENSIONS--
readline
--SKIPIF--
<?crx
if (substr(CRX_OS, 0, 3) == "WIN") {
    die("skip non windows test");
}
if (!readline_info("done")) {
    die("skip readline support required");
}
exec('which expect', $output, $ret);
if ($ret) {
    die("skip no expect installed");
}
?>
--FILE--
<?crx
$expect_executable = trim(`which expect`);
$crx_executable = getenv('TEST_CRX_EXECUTABLE_ESCAPED');
$script = __DIR__ . "/expect.sh";

if (extension_loaded("readline")) {
    $expect_script = <<<SCRIPT

set crx_executable [lindex \$argv 0]

spawn \$crx_executable -n -d cli.prompt="" -a

expect "crx >"

send "echo 'hello world';\n"
send "\04"

expect eof

exit

SCRIPT;

} else {
    $expect_script = <<<SCRIPT

set crx_executable [lindex \$argv 0]

spawn \$crx_executable -n -d cli.prompt="" -a

expect "Interactive mode enabled"

send "<?crx echo 'hello world';\n"
send "\04"

expect eof

exit

SCRIPT;
}

file_put_contents($script, $expect_script);

system($expect_executable . " " . $script . " " . $crx_executable);

@unlink($script);
?>
--EXPECTF--
spawn %scrx -n -d cli.prompt="" -a
Interactive %s

%Secho 'hello world';
%Shello world
